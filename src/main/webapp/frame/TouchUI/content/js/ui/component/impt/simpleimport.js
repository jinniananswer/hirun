/*!
 * simple import component
 * http://www.wadecn.com/
 * auth:xiedx@asiainfo.com
 * Copyright 2015, WADE
 */
!function(e,i,t){"use strict";if(e&&"undefined"==typeof e.Import){var l=(Array.prototype.splice,3e3),r=function(i,l){var r=this;r.el=i&&1==i.nodeType?i:t.getElementById(i),r.el&&r.el.nodeType&&(r.id=e.attr(r.el,"id"))&&(l&&e.isObject(l)&&e.extend(r,l),e.attr(r.el,"x-wade-uicomponent")||e.attr(r.el,"x-wade-uicomponent","simpleimport"),r._init(),r.constructor.call(r))};r.prototype=e.extend(new e.UIComponent,{setParams:function(i){var t=this;i&&e.isString(i)&&(t.params=i)},buildParams:function(i){var t=this,l=[];return l.push("rpcSessionId="+t.rpcSessionId),l.push("pushMode="+t.pushMode),l.push("config="+(t.configFile?t.configFile:"")),l.push("ftpSite="+(t.ftpCode?t.ftpCode:"")),l.push("filePath="+(t.filePath?t.filePath:"import")),l.push("fileId="+(t.file?t.file.fileId:"")),l.push("fileName="+(t.file?encodeURIComponent(t.file.name):"")),l.push("fileType="+(t.fileType?t.fileType:"")),l.push("model="+(t.model?t.model:"")),l.push("posX="+(t.posX?t.posX:"")),l.push("posY="+(t.posY?t.posY:"")),l.push("txtSplit="+(t.txtSplit?t.txtSplit:"")),l.push("fileSerializeId="+(t.fileSerializeId?t.fileSerializeId:"")),l.push("taskId="+(t.taskId?t.taskId:"")),l.push("serviceName="+(t.taskId?t.taskId:"")),l.push("listenerMethod="+(i?i:"")),e.ajax.buildSubmitData(t.cond,l.join("&")+(t.params&&e.isString(t.params)?"&"+t.params:""))},tip:function(e,i){var t=this;void 0!=e&&(t.nameEl.value=e),void 0!=i&&(t.nameEl.className=i)},getDisabled:function(){var e=this;return e.disabled},setDisabled:function(i){var t=this;t.disabled=!!i;var l=t.span.className?t.span.className:"";t.disabled?((" "+l+" ").indexOf(" e_dis ")<0&&(t.span.className=e.trim(l+" e_dis")),t.nameEl.disabled=!0):(l=e.trim((" "+l+" ").replace(/ e_dis /gi," ")),t.span.className=l,t.nameEl.disabled=!1)},destroy:function(){var e=this;if(e.rpc&&(e.rpc.destroy(),e.rpc=null),e.file){for(var i in e.file)delete e.file[i];e.file=null}e.swfup&&(e.swfup.destroy(),e.swfup=null),e.transfer&&(e.transfer.destroy(),e.transfer=null),e.span=null,e.nameEl=null,e.fileFormEl=null,e.fileEl=null,e.btnDownload=null,e.btnBrowser=null,e.btnImport=null,e.progEl=null,e.progBarEl=null,e.el=null,e.defaultTip=null},_init:function(){var i=this;i.url=e.FILE_UPLOAD_URL+(i.ftpCode?"&ftpSite="+i.ftpCode:"")+(i.filePath?"&filePath="+i.filePath:""),i.span=e(i.el).parent("span.e_mix:first")[0],i.nameEl=e(i.span).children("input[type=text]:first")[0],i.fileFormEl=e(i.span).children("form:first")[0],i.fileEl=e(i.fileFormEl).children("input:first")[0],i.btnDownload=e(i.span).children("span.e_ico-download:first")[0],i.btnBrowser=e(i.span).children("span.e_ico-browse:first")[0],i.btnImport=e(i.span).find("span.e_ico-import:first").parent("button:first")[0],i.progEl=e(i.span).children("span.e_mixProgress:first")[0],i.progBarEl=e(i.progBarEl).children("span.e_mixBar:first")[0];var t=e.attr(i.nameEl,"id");t||(t=i.id+"_name",e.attr(i.nameEl,"id",t)),e.attr(i.el,"x-visible-element",t),i.templateFile&&e.isString(i.templateFile)&&(i.btnDownload.style.display="",e.attr(i.btnDownload,"tip",e.lang.get("ui.component.simpleimport.tip.tpldownload"))),i.fileTypes&&(i.fileTypes=e.FileTransfer.fileTypes(i.fileTypes),i.fileTypes&&e.attr(i.fileEl,"accept",e.FileTransfer.mimeType(i.fileTypes))),i.fileTypeTip=i.fileTypes&&i.fileTypes.length?e.lang.get("ui.component.simpleimport.tip.support-filetypes",i.fileTypes.join(",")):"",i.fileTypeTip&&e.attr(i.btnBrowser,"tip",i.fileTypeTip),i.rpcSessionId=e.expando+"_"+e.rand(1e6)+"_"+i.id,i.useSwfUpload=e.browser.msie&&e.browser.version<10,1==i.useSwfUpload?(e(i.btnBrowser).append('<span id="'+i.id+'_swfupload_holder"></span>'),i.swfup=new SWFUpload({upload_url:i.url,file_size_limit:i.fileSize,file_types:i.fileTypes&&i.fileTypes.length?(""+i.fileTypes.join(";")).replace(/\./g,"*."):null,flash_url:"v5/jcl/plugins/swfupload/swfupload.swf",flash9_url:"v5/jcl/plugins/swfupload/swfupload_fp9.swf",button_placeholder_id:i.id+"_swfupload_holder",button_window_mode:SWFUpload.WINDOW_MODE.TRANSPARENT,button_cursor:SWFUpload.CURSOR.HAND,file_queued_handler:function(e){i._setFile(e),this.startUpload()},file_queue_error_handler:function(t,l,r){switch(l){case SWFUpload.QUEUE_ERROR.FILE_EXCEEDS_SIZE_LIMIT:alert(e.lang.get("ui.component.upload.tip.invalid-filesize")+" "+t.name);break;case SWFUpload.QUEUE_ERROR.INVALID_FILETYPE:alert(e.lang.get("ui.component.upload.tip.invalid-filetype")+" "+t.name);break;case SWFUpload.QUEUE_ERROR.QUEUE_LIMIT_EXCEEDED:alert(e.lang.get("ui.component.upload.tip.file-num-limit",i.fileLimit)+" "+t.name)}},upload_start_handler:function(e){i._transferStart(i.file)},upload_progress_handler:function(e,t,l){i._transferProgress(t,l,i.file)},upload_success_handler:function(t,l){i._transferSuccess(e.parseJSON(l),"suc",i.file)},upload_error_handler:function(e,t,l){i._transferError(t,l,i.file)}})):i.transfer=new e.FileTransfer({context:i,url:i.url,start:i._transferStart,success:i._transferSuccess,error:i._transferError,progress:function(e,t){i._transferProgress(e.loaded,e.total,t)}}),e(i.btnDownload).tap(function(){i.disabled||!0===i.uploading||!0===i.importing||(i.downUrl?e.FileTransfer.download(i.downUrl+"&_="+Math.random()):i.templateFile&&e.FileTransfer.download(i.templateFile))}),e(i.btnBrowser).tap(function(){i.disabled||!0===i.uploading||!0===i.importing||i.useSwfUpload||i.fileEl.click()}),e(i.fileEl).bind("change",function(){if(!i.disabled&&!0!==i.uploading&&!0!==i.importing){if(i.auto&&!1===e.event.trigger("beforeAction",null,i.el))return void(i.fileFormEl&&i.fileFormEl.nodeType&&i.fileFormEl.reset());if(!(i.fileEl.files.length<=0)){var t=i.fileEl.files[0];i._setFile(t),i.file&&!i.useSwfUpload&&(i.downUrl&&(i.downUrl=null,e.attr(i.btnDownload,"tip",e.lang.get("ui.component.simpleimport.tip.tpldownload"))),i.transfer.file=i.file,i.transfer.send(),i.uploading=!0)}}}),i.auto||e(i.btnImport).tap(function(){i.disabled||!0===i.uploading||!0===i.importing||!1!==e.event.trigger("beforeAction",null,i.el)&&i._doImport()})},_setFile:function(i){var t=this,l=i.name,r=i.size,n=!0;return t._validateFileType(l)?n&&r>t.fileSize?(n=!1,void t.tip(e.lang.get("ui.component.simpleupload.tip.invalid-filesize"),"e_red")):void(t.file={name:l,size:r,valid:n,fileObject:i}):(n=!1,void t.tip(e.lang.get("ui.component.simpleupload.tip.invalid-filetype"),"e_red"))},_validateFileType:function(i){var t=this;if(!t.fileTypes||!t.fileTypes.length)return!0;var l=e.FileTransfer.extName(i);return l&&e.isString(l)&&e.inArray(l,t.fileTypes)>-1||void 0==l},_transferStart:function(e){var i=this;i.progBarEl.style.width="0%",i.tip(e.name,"e_black-light")},_transferSuccess:function(e,i,t){var l,r,n=this,a=-1;return e&&e.context&&e.data&&(r=e.data.fileId)?(n.uploading=!1,t.fileId=n.el.value=r,t.fileObject=null,n.fileFormEl&&n.fileFormEl.nodeType&&n.fileFormEl.reset(),n.progBarEl.style.width="0%",n.tip(t.name),void(n.auto?n._doImport():n.btnImport.style.display="")):(a=e&&e.context?e.context.x_resultcode:"-1",l=e&&e.context?e.context.x_resultinfo:"",void n._transferError.call(n,a,l,t))},_transferError:function(i,t,l){var r=this;r.uploading=!1,l.fileObject=null,r.fileFormEl&&r.fileFormEl.reset(),r.tip(e.lang.get("ui.component.simpleimport.tip.upload-faild-info",t?t:"Status("+i+")"),"e_red")},_transferProgress:function(i,t,l){var r=this,n=i>0&&t>0?Math.round(i/t*100):0;n>=100&&(n=99),r.progBarEl.style.width=n+"%",r.tip(e.lang.get("ui.component.simpleimport.tip.uploading",n,l.name))},_doImport:function(){var t=this;t.fileSerializeId=null,t.tip(e.lang.get("ui.component.simpleimport.tip.begin-import",t.file.name)),e.ajaxRequest({url:e.IMPEXP_URL+"?_="+Math.random(),data:t.buildParams("refreshStatus"),type:"POST",dataType:"json",encoding:"UTF-8",timeout:3e4,success:function(r){if(t.fileSerializeId=r.fileSerializeId,t.messageServer=r.messageServer,t.messageServerType=r.messageServerType?r.messageServerType:null,!0===t.importing)if("10"==r.progress)t.tip(e.lang.get("ui.component.simpleimport.tip.import-started"));else{if(!t.fileSerializeId&&"error"==r.status)return t.importing=!1,t.progBarEl.style.width="0%",void t.tip(r.hint,"e_red");t.progBarEl.style.width=r.progress+"%",t.tip(e.lang.get("ui.component.simpleimport.tip.importing",r.progress+"%",t.file.name))}1==t.pushMode?t.messageServer&&!t.rpc&&(t.rpc=new e.RPC({address:t.messageServer,type:t.messageServerType,session:"&sessionId="+t.rpcSessionId,message:function(i){if(i&&e.isObject(i)){if(t.importing=!1,t.btnImport.style.display="none","ok"==i.STATUS){t.progBarEl.style.width="100%";var l=i.ERROR_INFO,r=t.downUrl=i.DOWNLOAD_URL;r&&e.attr(t.btnDownload,"tip",e.lang.get("ui.component.simpleimport.tip.faild-data-download"));var n=e.lang.get("ui.component.simpleimport.tip.import-complete");if(/^[0-9,]+$/.test(l)){var a=l.split(",");n+=" "+e.lang.get("ui.component.simpleimport.tip.import-count",a[0],a[1])}t.tip(n,"e_black-light")}else"error"==i.STATUS&&(t.progBarEl.style.width="0%",t.tip(i.ERROR_INFO,"e_red"));e.event.trigger("afterAction",i.STATUS,t.el)}}}),t.rpc.open()):t.timer=i.setInterval(function(){return t.fileSerializeId?void e.ajaxRequest({url:e.IMPEXP_URL+"?_="+Math.random(),data:t.buildParams("refreshStatus"),type:"POST",dataType:"json",encoding:"UTF-8",timeout:3e4,success:function(l){if(!l||!e.isObject(l))return void i.clearInterval(t.timer);if("100"==l.progress||"error"==l.status){if(i.clearInterval(t.timer),t.importing=!1,t.btnImport.style.display="none","ok"==l.status){t.progBarEl.style.width="100%";var r=l.hint,n=t.downUrl=l.downloadUrl;n&&e.attr(t.btnDownload,"tip",e.lang.get("ui.component.simpleimport.tip.faild-data-download"));var a=e.lang.get("ui.component.simpleimport.tip.import-complete");if(/^[0-9,]+$/.test(r)){var o=r.split(",");a+=" "+e.lang.get("ui.component.simpleimport.tip.import-count",o[0],o[1])}t.tip(a,"e_black-light")}else"error"==l.status&&(t.progBarEl.style.width="0%",t.tip(l.hint,"e_red"));e.event.trigger("afterAction",l.status,t.el)}},error:function(l,r,n){i.clearInterval(t.timer),t.importing=!1,t.tip(e.lang.get("ui.component.simpleimport.tip.import-faild",r),"e_red")}}):void i.clearInterval(t.timer)},l)},error:function(i,l,r){t.importing=!1,t.tip(e.lang.get("ui.component.simpleimport.tip.import-faild",l),"e_red")}}),t.importing=!0}}),i.SimpleImport=e.SimpleImport=r}}(window.Wade,window,document);